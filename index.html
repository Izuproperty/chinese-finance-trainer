<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chinese Finance Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f4f5f7;
      color: #222;
    }
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    #app {
      max-width: 960px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
    }
    h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    .subtitle {
      margin: 4px 0 16px 0;
      color: #666;
      font-size: 0.9rem;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 6px 14px;
      background: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .tab-btn.active {
      background: #0052cc;
      color: #fff;
      border-color: #0052cc;
    }
    .card {
      background: #fff;
      padding: 18px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }
    h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      background: #eee;
      font-size: 0.8rem;
      margin-left: 8px;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 6px 14px;
      background: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s, border-color 0.15s, transform 0.05s;
    }
    button.primary {
      background: #0052cc;
      color: #fff;
      border-color: #0052cc;
    }
    button:active {
      transform: scale(0.97);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .hidden {
      display: none;
    }
    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 0.9rem;
      margin-top: 6px;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
    }
    .field-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #777;
      margin-top: 10px;
      margin-bottom: 2px;
    }
    .highlight-zh {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }
    .highlight-py {
      font-size: 1rem;
      color: #555;
    }
    .highlight-en {
      font-size: 0.95rem;
      color: #333;
      margin-top: 4px;
    }
    .status {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #444;
    }
    .status.good { color: #137333; }
    .status.warn { color: #b36b00; }
    .status.bad  { color: #cc0000; }
    .muted {
      font-size: 0.85rem;
      color: #777;
    }
    .tone-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .tone-row label {
      font-size: 0.85rem;
    }
    .tone-row select {
      border-radius: 6px;
      padding: 2px 4px;
      font-size: 0.85rem;
    }
    @media (max-width: 600px) {
      .highlight-zh { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
<div id="app">
  <h1>Chinese Finance Trainer</h1>
  <div class="subtitle">Flashcards ¬∑ Reading ¬∑ Speaking ¬∑ Audio ¬∑ Spaced repetition</div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="flashcards">Flashcards</button>
    <button class="tab-btn" data-tab="reading">Reading</button>
    <button class="tab-btn" data-tab="speaking">Speaking</button>
  </div>

  <!-- FLASHCARDS -->
  <section id="flashcards" class="card">
    <h2>
      Finance Vocabulary
      <span id="fc-progress" class="badge"></span>
      <span id="fc-due-badge" class="badge"></span>
    </h2>
    <div id="flashcard-content"></div>
    <div class="controls">
      <button id="fc-audio-btn" title="Play pronunciation">üîä Play audio</button>
      <button id="fc-check-btn" class="primary">Check answer</button>
      <button id="fc-next-btn" class="hidden">Next</button>
      <button id="fc-knew-btn" class="hidden">I knew it</button>
      <button id="fc-learning-btn" class="hidden">Still learning</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      Spaced repetition is stored locally in this browser. ‚ÄúI knew it‚Äù pushes reviews further out; ‚ÄúStill learning‚Äù keeps them frequent.
    </div>
  </section>

  <!-- READING -->
  <section id="reading" class="card hidden">
    <h2>Reading Practice
      <span id="rd-count" class="badge"></span>
    </h2>
    <div id="reading-content"></div>
    <div class="controls">
      <button id="rd-audio-btn">üîä Play sentence</button>
      <button id="rd-toggle-py-btn">Toggle pinyin</button>
      <button id="rd-toggle-en-btn">Toggle translation</button>
      <button id="rd-next-btn">Next</button>
      <button id="rd-refresh-btn">Refresh Caixin finance sentences</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      Caixin headlines are loaded via RSS (through a CORS-safe proxy). Many will not have pinyin or translation prefilled, but they are still good for reading practice.
    </div>
  </section>

  <!-- SPEAKING -->
  <section id="speaking" class="card hidden">
    <h2>Speaking & Pronunciation</h2>
    <div id="sp-target"></div>
    <div class="controls">
      <button id="sp-audio-btn">üîä Play target</button>
      <button id="sp-new-btn">New sentence</button>
      <button id="sp-start-btn" class="primary">Start speaking (zh-CN)</button>
      <button id="sp-stop-btn">Stop</button>
      <button id="sp-clear-btn">Clear</button>
    </div>
    <div class="field-label">Recognized text</div>
    <textarea id="sp-recognized" rows="3" readonly></textarea>
    <div id="sp-status" class="status"></div>
    <div class="muted" style="margin-top:8px;">
      Uses the browser Web Speech API (best in Chrome/Edge). Read the sentence in Mandarin; the app compares what you said with the target characters.
    </div>
  </section>
</div>

<script>
/*
  ========================================
  DATA: Core finance terms & seed sentences
  ========================================
*/
const TERMS = [
  { zh: "ËÇ°Á•®",       pinyin: "g«î pi√†o",                  en: "stock; equity" },
  { zh: "ÂÄ∫Âà∏",       pinyin: "zh√†i qu√†n",                en: "bond" },
  { zh: "Âà©Áéá",       pinyin: "l√¨ l«ú",                    en: "interest rate" },
  { zh: "ÈÄöËÉÄ",       pinyin: "t≈çng zh√†ng",               en: "inflation (colloquial)" },
  { zh: "ÈÄöË¥ßËÜ®ËÉÄ",   pinyin: "t≈çng hu√≤ p√©ng zh√†ng",      en: "inflation" },
  { zh: "Ê±áÁéá",       pinyin: "hu√¨ l«ú",                   en: "exchange rate" },
  { zh: "‰∫∫Ê∞ëÂ∏Å",     pinyin: "r√©n m√≠n b√¨",               en: "Renminbi (RMB)" },
  { zh: "ËµÑ‰∫ßË¥üÂÄ∫Ë°®", pinyin: "zƒ´ ch«én f√π zh√†i bi«éo",    en: "balance sheet" },
  { zh: "Âà©Ê∂¶Ë°®",     pinyin: "l√¨ r√πn bi«éo",              en: "income statement" },
  { zh: "Áé∞ÈáëÊµÅ",     pinyin: "xi√†n jƒ´n li√∫",             en: "cash flow" },
  { zh: "‰º∞ÂÄº",       pinyin: "g≈´ zh√≠",                   en: "valuation" },
  { zh: "Â∏ÇÁõàÁéá",     pinyin: "sh√¨ y√≠ng l«ú",              en: "P/E ratio" },
  { zh: "È£éÈô©ÁÆ°ÁêÜ",   pinyin: "fƒìng xi«én gu«én l«ê",       en: "risk management" },
  { zh: "ËµÑ‰∫ßÁÆ°ÁêÜ",   pinyin: "zƒ´ ch«én gu«én l«ê",         en: "asset management" },
  { zh: "ÊäïËµÑÈì∂Ë°å",   pinyin: "t√≥u zƒ´ y√≠n h√°ng",         en: "investment bank" },
  { zh: "Ë¥¢ÂØåÁÆ°ÁêÜ",   pinyin: "c√°i f√π gu«én l«ê",          en: "wealth management" },
  { zh: "ÂÆèËßÇÁªèÊµé",   pinyin: "h√≥ng guƒÅn jƒ´ng j√¨",       en: "macro economy" },
  { zh: "ÊµÅÂä®ÊÄß",     pinyin: "li√∫ d√≤ng x√¨ng",           en: "liquidity" },
  { zh: "‰ø°Áî®È£éÈô©",   pinyin: "x√¨n y√≤ng fƒìng xi«én",     en: "credit risk" },
  { zh: "ÁõëÁÆ°Êú∫ÊûÑ",   pinyin: "jiƒÅn gu«én jƒ´ g√≤u",        en: "regulator; supervisory authority" }
];

// Seed sentences; Caixin RSS will append to this
let readingSentences = [
  {
    zh: "‰∏≠ÂõΩÁöÑÂà©ÁéáÊîøÁ≠ñ‰ºöÁõ¥Êé•ÂΩ±Âìç‰∫∫Ê∞ëÂ∏ÅÊ±áÁéá„ÄÇ",
    pinyin: "Zh≈çng gu√≥ de l√¨ l«ú zh√®ng c√® hu√¨ zh√≠ jiƒì y«êng xi«éng r√©n m√≠n b√¨ hu√¨ l«ú.",
    en: "China's interest rate policy directly affects the RMB exchange rate."
  },
  {
    zh: "ÊäïËµÑÈì∂Ë°åÊ≠£Âú®Â∏ÆÂä©ÂÆ¢Êà∑Âú®È¶ôÊ∏ØÂèëË°åÁæéÂÖÉÂÄ∫Âà∏„ÄÇ",
    pinyin: "T√≥u zƒ´ y√≠n h√°ng zh√®ng z√†i bƒÅng zh√π k√® h√π z√†i XiƒÅng g«éng fƒÅ x√≠ng mƒõi yu√°n zh√†i qu√†n.",
    en: "The investment bank is helping a client issue USD bonds in Hong Kong."
  }
];

/*
  ========================================
  Utilities: Pinyin normalization & tones
  ========================================
*/
const DIACRITIC_MAP = {
  'ƒÅ':{base:'a',tone:1}, '√°':{base:'a',tone:2}, '«é':{base:'a',tone:3}, '√†':{base:'a',tone:4},
  'ƒì':{base:'e',tone:1}, '√©':{base:'e',tone:2}, 'ƒõ':{base:'e',tone:3}, '√®':{base:'e',tone:4},
  'ƒ´':{base:'i',tone:1}, '√≠':{base:'i',tone:2}, '«ê':{base:'i',tone:3}, '√¨':{base:'i',tone:4},
  '≈ç':{base:'o',tone:1}, '√≥':{base:'o',tone:2}, '«í':{base:'o',tone:3}, '√≤':{base:'o',tone:4},
  '≈´':{base:'u',tone:1}, '√∫':{base:'u',tone:2}, '«î':{base:'u',tone:3}, '√π':{base:'u',tone:4},
  '«ñ':{base:'√º',tone:1}, '«ò':{base:'√º',tone:2}, '«ö':{base:'√º',tone:3}, '«ú':{base:'√º',tone:4}
};

// remove tone marks & digits; keep base letters
function normalizePinyinPlain(str) {
  if (!str) return "";
  let out = "";
  for (const ch of str.toLowerCase()) {
    if (DIACRITIC_MAP[ch]) {
      out += DIACRITIC_MAP[ch].base;
    } else if (ch >= '0' && ch <= '9') {
      // skip tones digits
    } else if (ch === ' ' || ch === "'" || ch === "‚Äô" || ch === "Ôºå" || ch === ",") {
      // skip / normalize separators
    } else {
      out += ch;
    }
  }
  return out.replace(/[^a-z√º]/g, "");
}

// extract tone (1-4 or 0) from a syllable
function extractToneFromSyllable(syl) {
  for (const ch of syl) {
    if (DIACRITIC_MAP[ch]) return DIACRITIC_MAP[ch].tone;
    if (/[1-4]/.test(ch)) return parseInt(ch,10);
  }
  return 0;
}

/*
  ========================================
  SRS (Spaced Repetition) - "Medium"
  ========================================
*/
const SRS_KEY = "cn_finance_srs_v1"; // localStorage key

// structure: { [zh]: { intervalDays, dueAtMs, reps } }
let srsState = {};
try {
  const raw = localStorage.getItem(SRS_KEY);
  if (raw) srsState = JSON.parse(raw);
} catch (e) {
  srsState = {};
}

function saveSRS() {
  localStorage.setItem(SRS_KEY, JSON.stringify(srsState));
}

// Compute list of indices that are "due" today
function getDueOrder() {
  const now = Date.now();
  const due = [];
  const unknown = [];
  TERMS.forEach((t, idx) => {
    const st = srsState[t.zh];
    if (!st) {
      unknown.push(idx);
    } else if (st.dueAtMs <= now) {
      due.push(idx);
    }
  });
  // Priority: due first, then unknown; if nothing, fallback all
  if (due.length > 0) return due;
  if (unknown.length > 0) return unknown;
  return TERMS.map((t, idx) => idx);
}

// Simple medium-intensity update
function updateSRS(zh, rating) {
  const now = Date.now();
  const dayMs = 86400000;
  let st = srsState[zh] || { intervalDays: 0, dueAtMs: now, reps: 0 };

  if (rating === "known") {
    // medium Anki-like: 0 -> 1d -> 3d -> 7d -> 16d -> ...
    let iv = st.intervalDays;
    if (iv === 0) iv = 1;
    else if (iv < 3) iv = 3;
    else if (iv < 7) iv = 7;
    else iv = Math.round(iv * 2.3);
    if (iv > 90) iv = 90;
    st.intervalDays = iv;
    st.dueAtMs = now + iv * dayMs;
    st.reps = (st.reps || 0) + 1;
  } else if (rating === "learning") {
    // keep interval small
    st.intervalDays = 0;
    st.dueAtMs = now + 10 * 60 * 1000; // 10 minutes
    st.reps = (st.reps || 0);
  }

  srsState[zh] = st;
  saveSRS();
}

/*
  ========================================
  Flashcards logic
  ========================================
*/
const fcContentEl    = document.getElementById("flashcard-content");
const fcAudioBtn     = document.getElementById("fc-audio-btn");
const fcCheckBtn     = document.getElementById("fc-check-btn");
const fcNextBtn      = document.getElementById("fc-next-btn");
const fcKnewBtn      = document.getElementById("fc-knew-btn");
const fcLearningBtn  = document.getElementById("fc-learning-btn");
const fcProgressEl   = document.getElementById("fc-progress");
const fcDueBadgeEl   = document.getElementById("fc-due-badge");

let fcOrder = getDueOrder();
let fcIndex = 0;

function currentTerm() {
  if (fcOrder.length === 0) fcOrder = TERMS.map((t, i) => i);
  const idx = fcOrder[fcIndex] ?? fcOrder[0];
  return { term: TERMS[idx], idx };
}

function renderFlashcard() {
  const { term, idx } = currentTerm();
  const srs = srsState[term.zh];

  // top status badges
  fcProgressEl.textContent = `Card ${fcIndex + 1} of ${fcOrder.length}`;
  const dueOrder = getDueOrder();
  const dueCount = dueOrder.length;
  if (dueCount === TERMS.length) {
    fcDueBadgeEl.textContent = `All cards (no SRS data yet)`;
  } else if (dueCount === 0) {
    fcDueBadgeEl.textContent = `All caught up üéâ`;
  } else {
    fcDueBadgeEl.textContent = `${dueCount} due now`;
  }

  // build tone quiz row
  const syllables = term.pinyin.split(/\s+/).filter(Boolean);
  let toneHtml = `<div class="field-label">Tone quiz</div>
                  <div class="muted">Choose the tone (1‚Äì4 or 0) for each syllable.</div>
                  <div class="tone-row">`;
  syllables.forEach((syl, i) => {
    toneHtml += `
      <label>
        <span>${syl}</span>
        <select data-syll-idx="${i}">
          <option value="">?</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="0">0</option>
        </select>
      </label>
    `;
  });
  toneHtml += `</div>`;

  const statusLabel = !srs ? "New" : (srs.intervalDays === 0 ? "Learning" : "Review");

  fcContentEl.innerHTML = `
    <div class="highlight-zh">${term.zh}</div>
    <div class="muted">Status: ${statusLabel}</div>
    <button id="fc-inner-audio" style="margin-top:6px; margin-bottom:8px;">üîä Play "${term.zh}"</button>
    <div class="field-label">Type pinyin (tones optional)</div>
    <input type="text" id="fc-pinyin-input" placeholder="e.g., gupiao / gu3piao4 / g«îpi√†o" />
    ${toneHtml}
    <div id="fc-feedback" class="status"></div>
  `;

  // inner audio button
  document.getElementById("fc-inner-audio").addEventListener("click", () => {
    playChineseTTS(term.zh);
  });

  // hide post-answer buttons until check
  fcNextBtn.classList.add("hidden");
  fcKnewBtn.classList.add("hidden");
  fcLearningBtn.classList.add("hidden");
}

// pinyin + tone check combined
function checkFlashcardAnswer() {
  const { term } = currentTerm();
  const inputEl = document.getElementById("fc-pinyin-input");
  const fbEl    = document.getElementById("fc-feedback");
  if (!inputEl || !fbEl) return;

  const userRaw = (inputEl.value || "").trim().toLowerCase();
  if (!userRaw) {
    fbEl.textContent = "Type some pinyin first.";
    fbEl.className = "status warn";
    return;
  }

  const targetNorm = normalizePinyinPlain(term.pinyin);
  const userNorm   = normalizePinyinPlain(userRaw);

  let score = 0;
  for (let i=0;i<Math.min(targetNorm.length, userNorm.length);i++) {
    if (targetNorm[i] === userNorm[i]) score++;
  }
  const ratio = targetNorm.length ? score / targetNorm.length : 0;

  // tone scoring
  const syllables = term.pinyin.split(/\s+/).filter(Boolean);
  const correctTones = syllables.map(extractToneFromSyllable);
  const selects = fcContentEl.querySelectorAll("select[data-syll-idx]");
  const userTones = [];
  selects.forEach(sel => {
    const v = sel.value === "" ? null : parseInt(sel.value, 10);
    userTones.push(v);
  });

  let toneCorrect = 0;
  correctTones.forEach((t, i) => {
    if (t === userTones[i]) toneCorrect++;
  });

  let msg = `Pinyin match: ${Math.round(ratio*100)}% correct.<br/>
             Tones: ${toneCorrect}/${correctTones.length} correct.<br/>
             <span class="highlight-py">${term.pinyin}</span>
             <div class="highlight-en">${term.en}</div>`;

  let cls = "status warn";
  if (ratio > 0.85 && toneCorrect === correctTones.length) cls = "status good";
  else if (ratio < 0.5 || toneCorrect === 0) cls = "status bad";

  fbEl.innerHTML = msg;
  fbEl.className = cls;

  // Show SRS buttons now
  fcNextBtn.classList.remove("hidden");
  fcKnewBtn.classList.remove("hidden");
  fcLearningBtn.classList.remove("hidden");
}

fcCheckBtn.addEventListener("click", checkFlashcardAnswer);

// Next: advance within current due order
fcNextBtn.addEventListener("click", () => {
  if (fcOrder.length === 0) fcOrder = getDueOrder();
  fcIndex = (fcIndex + 1) % fcOrder.length;
  renderFlashcard();
});

// I knew it: update SRS, then next
fcKnewBtn.addEventListener("click", () => {
  const { term } = currentTerm();
  updateSRS(term.zh, "known");
  fcOrder = getDueOrder();
  fcIndex = 0;
  renderFlashcard();
});

// Still learning: update SRS as learning, then next
fcLearningBtn.addEventListener("click", () => {
  const { term } = currentTerm();
  updateSRS(term.zh, "learning");
  fcOrder = getDueOrder();
  fcIndex = 0;
  renderFlashcard();
});

// global audio button
fcAudioBtn.addEventListener("click", () => {
  const { term } = currentTerm();
  playChineseTTS(term.zh);
});

/*
  ========================================
  Browser TTS for Chinese (zh-CN)
  ========================================
*/
function playChineseTTS(text) {
  if (!("speechSynthesis" in window)) {
    alert("Speech synthesis is not supported in this browser.");
    return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "zh-CN";
  // Try to prefer a zh-CN voice, if available
  const voices = window.speechSynthesis.getVoices() || [];
  const zhVoice = voices.find(v => v.lang.startsWith("zh"));
  if (zhVoice) utter.voice = zhVoice;
  window.speechSynthesis.cancel(); // stop any ongoing speech
  window.speechSynthesis.speak(utter);
}

/*
  ========================================
  Reading: Caixin RSS + controls
  ========================================
*/
const rdContentEl   = document.getElementById("reading-content");
const rdCountEl     = document.getElementById("rd-count");
const rdAudioBtn    = document.getElementById("rd-audio-btn");
const rdTogglePyBtn = document.getElementById("rd-toggle-py-btn");
const rdToggleEnBtn = document.getElementById("rd-toggle-en-btn");
const rdNextBtn     = document.getElementById("rd-next-btn");
const rdRefreshBtn  = document.getElementById("rd-refresh-btn");

let rdIndex = 0;
let rdShowPinyin = false;
let rdShowEnglish = false;

// Caixin RSS via CORS-friendly proxy
const RSS_SOURCE = "https://rsshub.app/caixin/latest";
const RSS_PROXY  = "https://api.allorigins.win/get?url=";

async function refreshCaixinSentences(force = false) {
  try {
    const lsKey = "cn_finance_caixin_cache_v1";
    const metaKey = "cn_finance_caixin_meta_v1";
    const lastMeta = JSON.parse(localStorage.getItem(metaKey) || "{}");
    const now = Date.now();
    const dayMs = 24 * 60 * 60 * 1000;

    if (!force && lastMeta.lastFetch && (now - lastMeta.lastFetch) < dayMs) {
      // within 24h: use cached
      const cached = JSON.parse(localStorage.getItem(lsKey) || "[]");
      if (cached.length > 0) {
        readingSentences = readingSentences.concat(cached);
      }
      return;
    }

    const url = RSS_PROXY + encodeURIComponent(RSS_SOURCE);
    const resp = await fetch(url);
    if (!resp.ok) throw new Error("RSS fetch failed: " + resp.status);
    const data = await resp.json();
    const contents = data.contents;
    if (!contents) throw new Error("No contents from proxy.");

    const parser = new DOMParser();
    const doc = parser.parseFromString(contents, "text/xml");
    const items = Array.from(doc.querySelectorAll("item, entry"));
    const mapped = items.slice(0, 15).map(item => {
      const title = item.querySelector("title")?.textContent || "";
      return {
        zh: title,
        pinyin: "",  // left blank; still useful for reading
        en: ""       // no automatic translation here
      };
    }).filter(x => x.zh);

    if (mapped.length > 0) {
      localStorage.setItem(lsKey, JSON.stringify(mapped));
      localStorage.setItem(metaKey, JSON.stringify({ lastFetch: now }));
      readingSentences = readingSentences.concat(mapped);
    }
  } catch (e) {
    console.warn("Caixin RSS refresh failed:", e);
  }
}

function renderReading() {
  if (readingSentences.length === 0) {
    rdContentEl.innerHTML = "<p>No reading sentences available.</p>";
    rdCountEl.textContent = "";
    return;
  }
  if (rdIndex >= readingSentences.length) rdIndex = 0;
  const s = readingSentences[rdIndex];
  rdCountEl.textContent = `Sentence ${rdIndex + 1} of ${readingSentences.length}`;

  let html = `<div class="highlight-zh">${s.zh}</div>`;
  if (rdShowPinyin && s.pinyin) {
    html += `<div class="highlight-py">${s.pinyin}</div>`;
  } else if (rdShowPinyin && !s.pinyin) {
    html += `<div class="muted">Pinyin not available for this RSS item.</div>`;
  }
  if (rdShowEnglish && s.en) {
    html += `<div class="highlight-en">${s.en}</div>`;
  } else if (rdShowEnglish && !s.en) {
    html += `<div class="muted">No English translation available.</div>`;
  }
  rdContentEl.innerHTML = html;
}

rdTogglePyBtn.addEventListener("click", () => {
  rdShowPinyin = !rdShowPinyin;
  renderReading();
});
rdToggleEnBtn.addEventListener("click", () => {
  rdShowEnglish = !rdShowEnglish;
  renderReading();
});
rdNextBtn.addEventListener("click", () => {
  rdIndex = (rdIndex + 1) % readingSentences.length;
  renderReading();
});
rdAudioBtn.addEventListener("click", () => {
  if (readingSentences.length === 0) return;
  const s = readingSentences[rdIndex];
  playChineseTTS(s.zh);
});
rdRefreshBtn.addEventListener("click", async () => {
  await refreshCaixinSentences(true);
  rdIndex = 0;
  renderReading();
});

/*
  ========================================
  Speaking tab: target, TTS, recognition
  ========================================
*/
const spTargetEl    = document.getElementById("sp-target");
const spAudioBtn    = document.getElementById("sp-audio-btn");
const spNewBtn      = document.getElementById("sp-new-btn");
const spStartBtn    = document.getElementById("sp-start-btn");
const spStopBtn     = document.getElementById("sp-stop-btn");
const spClearBtn    = document.getElementById("sp-clear-btn");
const spTextEl      = document.getElementById("sp-recognized");
const spStatusEl    = document.getElementById("sp-status");

let speechRecognition = null;
let recognizing = false;
let spCurrent = null;

function pickSpeakingSentence() {
  if (readingSentences.length === 0) return;
  const idx = Math.floor(Math.random() * readingSentences.length);
  spCurrent = readingSentences[idx];
  spTargetEl.innerHTML = `
    <div class="highlight-zh">${spCurrent.zh}</div>
    ${spCurrent.pinyin ? `<div class="highlight-py">${spCurrent.pinyin}</div>` : ""}
    ${spCurrent.en ? `<div class="highlight-en">${spCurrent.en}</div>` : ""}
  `;
  spStatusEl.textContent = "Read the sentence aloud in Mandarin.";
  spStatusEl.className = "status";
}

function initSpeechRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    spStatusEl.textContent = "Speech recognition is not supported in this browser.";
    spStatusEl.className = "status bad";
    return null;
  }
  const recog = new SR();
  recog.lang = "zh-CN";
  recog.interimResults = true;
  recog.continuous = false;
  return recog;
}

function evaluatePronunciation(target, recognized) {
  const normalizeZh = s => (s || "").replace(/\s+/g, "").toLowerCase();
  const t = normalizeZh(target);
  const r = normalizeZh(recognized);
  if (!r) {
    spStatusEl.textContent = "No speech recognized. Try again closer to the mic.";
    spStatusEl.className = "status warn";
    return;
  }
  let score = 0;
  for (let i=0;i<Math.min(t.length, r.length);i++) {
    if (t[i] === r[i]) score++;
  }
  const ratio = t.length ? score / t.length : 0;
  if (ratio > 0.7) {
    spStatusEl.textContent = "Good match ‚Äì pronunciation and tones are probably acceptable.";
    spStatusEl.className = "status good";
  } else if (ratio > 0.4) {
    spStatusEl.textContent = "Partial match ‚Äì you got the general shape, but work on clarity and tones.";
    spStatusEl.className = "status warn";
  } else {
    spStatusEl.textContent = "Low match ‚Äì slow down, separate syllables, and exaggerate tones.";
    spStatusEl.className = "status bad";
  }
}

spNewBtn.addEventListener("click", pickSpeakingSentence);
spAudioBtn.addEventListener("click", () => {
  if (!spCurrent) return;
  playChineseTTS(spCurrent.zh);
});
spClearBtn.addEventListener("click", () => {
  spTextEl.value = "";
  spStatusEl.textContent = "";
  spStatusEl.className = "status";
});

spStartBtn.addEventListener("click", () => {
  if (!spCurrent) pickSpeakingSentence();
  if (!speechRecognition) speechRecognition = initSpeechRecognition();
  if (!speechRecognition) return;
  if (recognizing) return;

  recognizing = true;
  spTextEl.value = "";
  spStatusEl.textContent = "Listening‚Ä¶";
  spStatusEl.className = "status";

  speechRecognition.onresult = (event) => {
    let transcript = "";
    for (let i=0;i<event.results.length;i++) {
      transcript += event.results[i][0].transcript;
    }
    spTextEl.value = transcript;
  };
  speechRecognition.onerror = (event) => {
    recognizing = false;
    spStatusEl.textContent = "Error: " + event.error;
    spStatusEl.className = "status bad";
  };
  speechRecognition.onend = () => {
    recognizing = false;
    evaluatePronunciation(spCurrent?.zh || "", spTextEl.value);
  };
  speechRecognition.start();
});

spStopBtn.addEventListener("click", () => {
  if (speechRecognition && recognizing) {
    speechRecognition.stop();
  }
});

/*
  ========================================
  Tabs setup & initial bootstrap
  ========================================
*/
const tabButtons = document.querySelectorAll(".tab-btn");
const flashcardsSection = document.getElementById("flashcards");
const readingSection    = document.getElementById("reading");
const speakingSection   = document.getElementById("speaking");

tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    flashcardsSection.classList.toggle("hidden", tab !== "flashcards");
    readingSection.classList.toggle("hidden", tab !== "reading");
    speakingSection.classList.toggle("hidden", tab !== "speaking");
  });
});

// initial render
(async function init() {
  // Preload TTS voices for better zh-CN selection
  if ("speechSynthesis" in window) {
    window.speechSynthesis.onvoiceschanged = () => {};
  }
  // Attempt to refresh Caixin sentences (cached if <24h)
  await refreshCaixinSentences(false);
  // Flashcards, reading, speaking
  fcOrder = getDueOrder();
  fcIndex = 0;
  renderFlashcard();
  renderReading();
  pickSpeakingSentence();
})();
</script>
</body>
</html>
